<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <!-- blank favicon -->
    <link href="data:image/x-icon;base64,iVBORw0KGgo=" rel="icon" type="image/x-icon" />
    <title>AR demo</title>

    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        body 
        { 
            margin: 0; 
            overflow: hidden; 
        }
    </style>

</head>
<body>

<script>
AFRAME.registerComponent('marker-handler', 
{
   init: function()
   {
        this.model = document.querySelector("#model");
        this.markerArray = document.querySelectorAll("a-marker");
        this.visibleMarkerIndex = -1;
        this.currentMarkerIndex = -1;
   },

   tick: function() 
   {
        this.visibleMarkerIndex = -1;
        for (let i = 0; i < this.markerArray.length; i++)
            if (this.markerArray[i].object3D.visible)
                this.visibleMarkerIndex = i;
        
        // console.log( this.visibleMarkerIndex );

        // the rest of this function can be skipped if there has been no change
        if ( this.visibleMarkerIndex == this.currentMarkerIndex )
        {
            console.log( "visible: no change" );
            return;
        }
        else
        {
            console.log( "visible: " + this.visibleMarkerIndex );
            this.currentMarkerIndex = this.visibleMarkerIndex;
        }

        if ( this.visibleMarkerIndex == -1 )
            this.model.object3D.visible = false;
        else
        {
            this.model.object3D.visible = true;

            if (this.model.object3D.parent)
                this.model.object3D.parent.remove( this.model.object3D );

            this.markerArray[this.visibleMarkerIndex].children[0].add( this.model );
        }

   }
});

</script>

<!-- 
    cameraParametersUrl: uses local data, so internet connection not required
    logarithmicDepthBuffer: reduces z-fighting when marker is at greater distance from camera
 -->
<a-scene embedded
    shadow="type: pcfsoft"
    vr-mode-ui="enabled: false"
    arjs="detectionMode: mono_and_matrix; matrixCodeType: 3x3; cameraParametersUrl: data/camera_para.dat"
    renderer="logarithmicDepthBuffer: true;">

    <!--
        boxes must be raised for bottom side to "sit" on AR marker surface
        <a-box position="0 0.5 0" color="red" material="transparent:true; opacity:0.50;"></a-box>
    -->

    <!--
    <a-marker type="barcode" value="0" smooth="true">
        <a-plane color="red" rotation="-90 0 0" material="transparent:true; opacity:0.50;">
            <a-entity text="value: Hello\nWorld; align:center; color:navy; width:8.0;" position="0 0 0.01">
            </a-entity>
        </a-plane>
    </a-marker>
    -->

    <a-entity camera>
        <a-entity light="type: ambient; color: #888"></a-entity>
        <a-entity light="type: directional; color: #FFF; intensity: 1.8" position="-0.5 1 1"></a-entity>
    </a-entity> 
</a-scene>

<script>
function createBarcodeMarker(id) 
{
    const marker = document.createElement('a-marker');
    marker.setAttribute('type', 'barcode');
    marker.setAttribute('value', String(id));

    const plane = document.createElement('a-plane');
    plane.setAttribute('color', '#ff0000');
    plane.setAttribute('opacity', 0.4);
    plane.setAttribute('rotation', '-90 0 0');
    plane.setAttribute('position', '0 0.001 0');
    marker.appendChild(plane);

    // numeric label (marker ID), centered on the square
    const label = document.createElement('a-entity');
    label.setAttribute('text', `value: _${id}_; align: center; color: navy; width: 8.0;`);
    label.setAttribute('position', '0 0 0.01');
    plane.appendChild(label);

    /*
    // (Optional) Listen to found/lost events if you need custom logic
    // marker.addEventListener('markerFound', () => console.log('Found ID', id));
    // marker.addEventListener('markerLost', () => console.log('Lost  ID', id));
    */

    return marker;
}


const scene = document.querySelector('a-scene');

for (let i = 0; i < 64; i++)
    scene.appendChild( createBarcodeMarker(i) );

</script>

</body>
</html>



